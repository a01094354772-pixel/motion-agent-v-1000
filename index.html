import React, { useState, useEffect, useCallback, useRef } from 'react';

// --- 전역 설정 및 상수 ---
const apiKey = ""; // 런타임에서 자동 제공

const App = () => {
  const [libraryData, setLibraryData] = useState([]);
  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [isRestoring, setIsRestoring] = useState(false);
  const [isExpanding, setIsExpanding] = useState(false);
  const [isMatching, setIsMatching] = useState(false);
  
  const [restoreProgress, setRestoreProgress] = useState(0); 
  const [expandProgress, setExpandProgress] = useState(0);  
  
  const [logs, setLogs] = useState([
    "> 1년치 유인 운전 데이터 분석 완료 (누적 70,000km)",
    "> 위험 징후 및 임계 거동 씨앗(Seed) 데이터 100건 추출 성공",
    "> 사고 원인 대조 라이브러리 구축 대기 중..."
  ]);
  
  const [aiAnalysis, setAiAnalysis] = useState("라이브러리에서 분석 대상을 선택하거나 '대조 판독 가동'을 클릭하십시오.");
  const [isAiLoading, setIsAiLoading] = useState(false);

  // 사고 판독을 위한 법적/기술적 표준 규정
  const standards = {
    speed: 60.0,
    friction: 0.8,
    sysLatency: 0.1,
    commLatency: 0.1
  };

  const logEndRef = useRef(null);
  const scrollToBottom = () => {
    logEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [logs]);

  // --- Gemini API 호출 함수 ---
  const callGemini = async (prompt, systemInstruction = "당신은 자율주행 사고 데이터 분석 전문가입니다. 사고 시나리오 간의 물리적 유사성을 바탕으로 인과관계를 설명하며, 모든 데이터는 무결성이 담보된 상태임을 전제합니다.") => {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: { parts: [{ text: systemInstruction }] }
    };

    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
          return result.candidates[0].content.parts[0].text;
        }
        throw new Error("Invalid format");
      } catch (error) {
        await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
      }
    }
    throw new Error("API call failed");
  };

  // --- 라이브러리 생성: 1,000건 전체에 독립적 데이터 부여 ---
  const initLibrary = useCallback(() => {
    const data = [];
    for (let i = 1; i <= 1000; i++) {
      const s = 50 + Math.random() * 50; 
      const f = 0.1 + Math.random() * 0.8; 
      const sl = 0.05 + Math.random() * 0.4; 
      const cl = 0.05 + Math.random() * 0.3; 

      const speedDev = Math.max(0, s - standards.speed) * 2;
      const fricDev = Math.max(0, standards.friction - f) * 100;
      const sysDev = Math.max(0, sl - standards.sysLatency) * 200;
      const commDev = Math.max(0, cl - standards.commLatency) * 150;
      
      const totalDev = (speedDev + fricDev + sysDev + commDev) || 1;
      
      data.push({ 
        id: i, 
        type: 'accident',
        actual: { speed: s, friction: f, sysLatency: sl, commLatency: cl },
        contrib: { 
          speed: Math.round((speedDev / totalDev) * 100), 
          friction: Math.round((fricDev / totalDev) * 100), 
          sysLatency: Math.round((sysDev / totalDev) * 100), 
          commLatency: Math.round((commDev / totalDev) * 100) 
        }
      });
    }
    setLibraryData(data);
  }, []);

  useEffect(() => { initLibrary(); }, [initLibrary]);

  // --- 1단계: 100Hz 물리 복원 시연 ---
  const startRestoration = () => {
    setIsRestoring(true);
    let count = 0;
    setLogs(prev => [...prev, "> [공정 1] 100건의 유인 실측 씨앗 데이터(Seed) 100Hz 물리 복원 개시..."]);
    const interval = setInterval(() => {
      count += 10;
      setRestoreProgress(count);
      if (count >= 100) {
        clearInterval(interval);
        setIsRestoring(false);
        setLogs(prev => [...prev, "> [완료] 100건 데이터 복원 성공. (데이터 해상도 100배 향상 및 원천 로그 보안 잠금)"]);
      }
    }, 80);
  };

  // --- 2단계: 1,000건 사고 대조군 라이브러리 확장 ---
  const startExpansion = () => {
    if (restoreProgress < 100) return;
    setIsExpanding(true);
    let count = 0;
    setLogs(prev => [...prev, "> [공정 2] 복원된 궤적에 변수를 대입하여 1,000건의 사고 대조군 시나리오 합성 중..."]);
    const interval = setInterval(() => {
      count += 100;
      setExpandProgress(count);
      if (count >= 1000) {
        clearInterval(interval);
        setIsExpanding(false);
        setLogs(prev => [...prev, "> [완료] 1,000건의 사고 판독 전용 대조 라이브러리 구축이 완료되었습니다. 데이터 무결성을 담보합니다."]);
      }
    }, 80);
  };

  // --- 3단계: 실제 사고 데이터 대조 분석 ---
  const runMatchingDiagnostics = async () => {
    if (expandProgress < 1000) return;
    setIsMatching(true);
    setSelectedIndex(-1);
    setLogs(prev => [...prev, "> [공정 3] 인입된 실제 사고 데이터 분석 시작. 라이브러리 대조 매칭 가동..."]);
    
    let scanCount = 0;
    const scanInterval = setInterval(() => {
      setSelectedIndex(Math.floor(Math.random() * 1000));
      scanCount++;
      if (scanCount > 25) {
        clearInterval(scanInterval);
        const matchIdx = 0; 
        setSelectedIndex(matchIdx);
        setIsMatching(false);
        setLogs(prev => [...prev, `> [매칭 성공] 라이브러리 시나리오 #${matchIdx + 1}과 물리 거동 잔차 0.2% 이내 일치.`, `> 정보: 매칭된 모델의 데이터를 기반으로 무결성이 담보된 정밀 분석을 시작합니다.`]);
      }
    }, 80);
  };

  const handleSelectCase = (idx) => {
    if (expandProgress < 1000) return;
    setSelectedIndex(idx);
    setAiAnalysis("이 케이스의 상세 데이터를 분석하려면 아래 'AI 정밀 인과관계 판독' 버튼을 클릭하십시오.");
  };

  const getDynamicVerdict = (data) => {
    if (!data) return "데이터 매칭 및 사고 인과 분석 중...";
    const { speed, friction, sysLatency, commLatency } = data.contrib;
    const maxVal = Math.max(speed, friction, sysLatency, commLatency);
    if (maxVal === speed) return "대조 결과: 규정 속도 초과에 의한 물리적 제동 거리가 사고의 결정적 원인으로 분석됨";
    if (maxVal === sysLatency) return "대조 결과: 시스템 인지 지연이 설계 표준을 상회하여 물리적 회피가 불가능했던 것으로 분석됨";
    if (maxVal === friction) return "대조 결과: 노면 마찰력 급감이 제동력 생성의 핵심적 저해 요인으로 분석됨";
    if (maxVal === commLatency) return "대조 결과: 네트워크 지연으로 인한 명령 전달 오류가 사고에 직접적 영향 미침";
    return "복합 요인 분석 리포트 확인 요망";
  };

  const analyzeWithGemini = async () => {
    if (selectedIndex === -1) return;
    const data = libraryData[selectedIndex];
    setIsAiLoading(true);
    setAiAnalysis("");
    const prompt = `
      [자율주행 실제 사고 대조 분석 보고서]
      사례번호: #${data.id}
      
      1. 실측값 대 표준규정 대조:
      - 속도: 실측 ${data.actual.speed.toFixed(1)}km/h (규정 ${standards.speed.toFixed(1)}km/h)
      - 노면: 실측 ${data.actual.friction.toFixed(1)}μ (표준 ${standards.friction.toFixed(1)}μ)
      - 시스템지연: 실측 ${data.actual.sysLatency.toFixed(1)}s (설계 ${standards.sysLatency.toFixed(1)}s)
      - 통신지연: 실측 ${data.actual.commLatency.toFixed(1)}s (설계 ${standards.commLatency.toFixed(1)}s)
      
      2. 과실 기여도 매칭 결과:
      - 속도 ${data.contrib.speed}%, 노면 ${data.contrib.friction}%, 시스템 ${data.contrib.sysLatency}%, 통신 ${data.contrib.commLatency}%

      위 데이터를 바탕으로 보험사나 당사자에게 객관적인 '공학적 분석 리포트'를 3문장 이내로 작성하세요.
      선택된 사례의 결정적 원인을 명시하되, 해당 데이터의 기록 무결성이 기술적으로 담보되고 있음을 강조하세요.
    `;
    try {
      const result = await callGemini(prompt);
      setAiAnalysis(result);
    } catch {
      setAiAnalysis("분석 실패. 다시 시도하십시오.");
    } finally {
      setIsAiLoading(false);
    }
  };

  const selectedData = selectedIndex !== -1 ? libraryData[selectedIndex] : null;

  return (
    <div className="bg-[#020202] min-h-screen text-slate-200 font-sans p-4 md:p-8">
      {/* Header */}
      <header className="max-w-[1500px] mx-auto border-b border-[#deff9a]/20 pb-6 mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
          <h1 className="text-3xl font-black text-[#deff9a] tracking-tighter uppercase italic">Motion Agent-V</h1>
          <p className="text-slate-500 text-sm mt-1 font-bold">실측 데이터 기반 사고 대조 판독 및 인과 분석 인프라 (v11.2)</p>
        </div>
        <div className="flex items-center gap-6">
          <div className="text-right">
            <span className="text-[10px] text-slate-500 font-bold block mb-1">데이터 신뢰 해상도</span>
            <span className="bg-emerald-500/10 text-emerald-400 text-[10px] px-3 py-1 rounded-full border border-emerald-500/20 font-bold uppercase tracking-widest">100Hz 고정밀 복원</span>
          </div>
          <div className="text-right">
            <span className="text-[10px] text-slate-500 font-bold block mb-1">기록 신뢰도</span>
            <span className="bg-blue-500/10 text-blue-400 text-[10px] px-3 py-1 rounded-full border border-blue-500/20 font-bold uppercase tracking-widest">데이터 무결성 담보</span>
          </div>
        </div>
      </header>

      <main className="max-w-[1500px] mx-auto grid grid-cols-1 xl:grid-cols-[400px_1fr] gap-8">
        {/* Left Operations */}
        <section className="space-y-6">
          <div className="bg-[#0d0d0d] rounded-3xl p-6 border border-white/5 shadow-2xl relative overflow-hidden text-left">
            <h2 className="text-[#deff9a] font-bold text-xs uppercase tracking-widest mb-6 flex items-center gap-2">
              <span className="w-2 h-2 bg-[#deff9a] rounded-full animate-pulse"></span>
              유인 실측 데이터 추출
            </h2>
            <div className="space-y-4 mb-8">
                <div className="bg-white/5 p-4 rounded-2xl border border-white/5 flex justify-between items-center">
                    <div>
                        <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">총 누적 실측 거리</p>
                        <p className="text-3xl font-black text-white">70,000 <span className="text-sm text-slate-600 font-normal ml-1">km</span></p>
                    </div>
                    <div className="text-right">
                        <span className="text-[10px] text-slate-500 font-bold block">표준 DTG 소스</span>
                        <span className="text-xs text-blue-400 font-bold">무결성 검증 완료</span>
                    </div>
                </div>
            </div>
            <h2 className="text-slate-500 font-bold text-[10px] uppercase tracking-widest mb-4 italic">분석 엔진 실행 단계</h2>
            <div className="space-y-3">
              <div className="space-y-2 mb-4">
                  <button onClick={startRestoration} disabled={isRestoring || restoreProgress === 100} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-700 transition-all disabled:opacity-30 text-sm">
                    {isRestoring ? "물리 궤적 복원 중..." : "1. 100Hz 물리 복원 시연"}
                  </button>
                  <div className="h-1 bg-white/5 rounded-full overflow-hidden">
                      <div className="h-full bg-emerald-400 transition-all duration-300" style={{ width: `${restoreProgress}%` }} />
                  </div>
              </div>
              <div className="space-y-2 mb-4">
                  <button onClick={startExpansion} disabled={isExpanding || expandProgress === 1000 || restoreProgress < 100} className="w-full bg-[#deff9a] text-black py-3 rounded-xl font-black hover:brightness-110 transition-all disabled:opacity-30 text-sm">
                    {isExpanding ? "사고 대조군 합성 중..." : "2. 1,000건 사고 라이브러리 확장"}
                  </button>
                  <div className="h-1 bg-white/5 rounded-full overflow-hidden">
                      <div className="h-full bg-blue-400 transition-all duration-300" style={{ width: `${(expandProgress/1000)*100}%` }} />
                  </div>
              </div>
              <button onClick={runMatchingDiagnostics} disabled={isMatching || expandProgress < 1000} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black hover:bg-blue-500 transition-all shadow-lg disabled:opacity-30 flex items-center justify-center gap-2">
                {isMatching ? "매칭 로직 가동 중..." : "3. 실제 사고 데이터 대조 분석 가동"}
                <i className="fa-solid fa-magnifying-glass-chart"></i>
              </button>
            </div>
          </div>
          <div className="bg-black/50 border border-white/5 rounded-2xl p-5 h-48 overflow-y-auto font-mono text-[10px] text-emerald-500/80 leading-relaxed custom-scrollbar">
            {logs.map((log, i) => <div key={i} className="mb-1">{log}</div>)}
            <div ref={logEndRef} />
          </div>
        </section>

        {/* Right Diagnosis */}
        <section className="space-y-6">
          <div className="bg-[#0d0d0d] rounded-3xl p-8 border border-white/5 shadow-2xl flex flex-col min-h-[750px]">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-black flex items-center gap-3">사고 원인 대조군 라이브러리 분포 일람</h2>
              <div className="flex gap-5 text-[10px] font-bold text-slate-400">
                <span className="flex items-center gap-1.5"><div className="w-3 h-3 bg-red-600 rounded-sm"></div> 분석 대상 사례 (사각형을 클릭하여 개별 분석 가능)</span>
              </div>
            </div>
            <div className="bg-black/80 rounded-2xl p-6 border border-white/5 mb-8 flex-grow overflow-hidden">
              <div className="grid grid-cols-[repeat(auto-fill,minmax(14px,1fr))] gap-2 h-full overflow-y-auto pr-4 custom-scrollbar">
                {libraryData.slice(0, expandProgress || 100).map((item, idx) => (
                  <div 
                    key={item.id} 
                    onClick={() => handleSelectCase(idx)}
                    className={`aspect-square rounded-sm cursor-pointer transition-all duration-300 bg-red-600 
                      ${selectedIndex === idx ? 'ring-4 ring-white scale-150 z-10 shadow-2xl shadow-white/80' : 'opacity-20 hover:opacity-100 scale-90'}`} 
                  />
                ))}
              </div>
            </div>

            {selectedData && (
              <div className="bg-white/[0.02] rounded-3xl border border-white/5 p-8 animate-in fade-in slide-in-from-bottom-4 duration-500 text-left">
                <div className="flex flex-col 2xl:flex-row gap-10">
                  <div className="flex-grow">
                    <div className="flex justify-between items-start mb-6">
                      <h3 className="text-2xl font-black italic tracking-tighter">데이터 매칭 분석 사례 #{String(selectedData.id).padStart(3, '0')}</h3>
                      <button onClick={analyzeWithGemini} disabled={isAiLoading} className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg shadow-blue-900/20">
                        {isAiLoading ? "분석 중..." : "AI 정밀 인과관계 판독"} <i className="fa-solid fa-wand-magic-sparkles"></i>
                      </button>
                    </div>
                    
                    <div className="overflow-hidden rounded-2xl border border-white/5 bg-black/40 mb-8 shadow-lg">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-white/5">
                                    <th className="p-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">분석 항목</th>
                                    <th className="p-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">실측 수치</th>
                                    <th className="p-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center">규정/설계 수치</th>
                                    <th className="p-4 text-[10px] font-bold text-[#deff9a] uppercase tracking-widest text-right">사고 기여도</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr className="border-t border-white/5 hover:bg-white/[0.02] transition-colors">
                                    <td className="p-4 font-bold text-slate-300 text-sm">주행 속도 (Speed)</td>
                                    <td className="p-4 text-center text-red-400 font-black text-lg">{selectedData.actual.speed.toFixed(1)} <small className="text-[10px] font-normal text-slate-500">km/h</small></td>
                                    <td className="p-4 text-center text-slate-500 text-sm font-bold">{standards.speed.toFixed(1)} km/h</td>
                                    <td className="p-4 text-right text-[#deff9a] font-black text-xl">{selectedData.contrib.speed}%</td>
                                </tr>
                                <tr className="border-t border-white/5 hover:bg-white/[0.02] transition-colors">
                                    <td className="p-4 font-bold text-slate-300 text-sm">노면 마찰 (Friction)</td>
                                    <td className="p-4 text-center text-blue-400 font-black text-lg">{selectedData.actual.friction.toFixed(1)} <small className="text-[10px] font-normal text-slate-500">μ</small></td>
                                    <td className="p-4 text-center text-slate-500 text-sm font-bold">{standards.friction.toFixed(1)} μ</td>
                                    <td className="p-4 text-right text-[#deff9a] font-black text-xl">{selectedData.contrib.friction}%</td>
                                </tr>
                                <tr className="border-t border-white/5 hover:bg-white/[0.02] transition-colors">
                                    <td className="p-4 font-bold text-slate-300 text-sm">시스템 지연 (System Latency)</td>
                                    <td className="p-4 text-center text-red-400 font-black text-lg">{selectedData.actual.sysLatency.toFixed(1)} <small className="text-[10px] font-normal text-slate-500">s</small></td>
                                    <td className="p-4 text-center text-slate-500 text-sm font-bold">{standards.sysLatency.toFixed(1)} s</td>
                                    <td className="p-4 text-right text-[#deff9a] font-black text-xl">{selectedData.contrib.sysLatency}%</td>
                                </tr>
                                <tr className="border-t border-white/5 hover:bg-white/[0.02] transition-colors">
                                    <td className="p-4 font-bold text-slate-300 text-sm">통신 지연 (Network Latency)</td>
                                    <td className="p-4 text-center text-emerald-400 font-black text-lg">{selectedData.actual.commLatency.toFixed(1)} <small className="text-[10px] font-normal text-slate-500">s</small></td>
                                    <td className="p-4 text-center text-slate-500 text-sm font-bold">{standards.commLatency.toFixed(1)} s</td>
                                    <td className="p-4 text-right text-[#deff9a] font-black text-xl">{selectedData.contrib.commLatency}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div className="pt-6 border-t border-white/5">
                      <span className="text-[#deff9a] text-[10px] font-black uppercase tracking-widest">공학적 데이터 분석 최종 결론</span>
                      <p className="text-xl font-bold text-white mt-3 leading-tight transition-all">{getDynamicVerdict(selectedData)}</p>
                    </div>
                  </div>

                  <div className="2xl:w-[450px] border-t 2xl:border-t-0 2xl:border-l border-white/5 pt-8 2xl:pt-0 2xl:pl-10 flex flex-col">
                    <h4 className="text-[11px] font-black text-slate-500 uppercase mb-6 flex items-center justify-between">AI 정밀 인과관계 판독 리포트 <i className="fa-solid fa-shield-halved text-blue-400"></i></h4>
                    <div className="bg-black/80 p-6 rounded-2xl text-[13px] text-slate-300 leading-relaxed border border-blue-500/20 flex-grow min-h-[350px] shadow-inner">
                      {isAiLoading ? (
                        <div className="flex flex-col items-center justify-center h-full gap-4 opacity-60">
                            <div className="w-8 h-8 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                            <span className="text-[10px] font-bold uppercase tracking-widest">데이터 무결성 담보 확인 중</span>
                        </div>
                      ) : (
                        <div className="whitespace-pre-wrap animate-in fade-in duration-700">{aiAnalysis}</div>
                      )}
                    </div>
                    <p className="text-[9px] text-slate-600 mt-4 text-center italic">* 본 분석 리포트는 위변조가 불가능한 실제 사고 로그에 기초하여 데이터 무결성을 담보합니다.</p>
                  </div>
                </div>
              </div>
            )}
            
            {!selectedData && (
              <div className="flex-grow flex items-center justify-center border border-dashed border-white/10 rounded-3xl bg-black/20 text-slate-600 italic">
                <p>라이브러리 분포 일람에서 분석하고자 하는 사각형(사례)을 선택하십시오.</p>
              </div>
            )}
          </div>
        </section>
      </main>
      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #deff9a; }
        .animate-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      `}</style>
    </div>
  );
};

export default App;